package com.piggy.coffee.https.utils;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.atomic.AtomicInteger;

import org.apache.http.impl.nio.client.CloseableHttpAsyncClient;
import org.junit.Test;

public class EvaNioHttpClientUtilsTest {

	@Test
	public void testEvaMultipleThreads() throws InterruptedException, ExecutionException, IOException {

		String url = "http://127.0.0.1:8080/bridge/game/gameEvaluate";
		String p = "?tpiID=%s&tpiGitURL=aHR0cDovLzEwLjkuNjIuMjE4OjkwMDAvcDg1MzQ2MTc5LzZpank5NHZxNW8yMDE5MDczMTA5MDUxNi5naXQ=&buildID=2120709&isPublished=1&instanceChallenge=5&testCases=W3siaW5wdXQiOiIzIDFcbjEgMiAzXG40IDUgNlxuNyA4IDkiLCJvdXRwdXQiOiIgMiAzIDFcbiA1IDYgNFxuIDggOSA3XG4ifSx7ImlucHV0IjoiNCAyXG4xIDIgMyA0XG4yIDMgNCA1XG4zIDQgNSA2XG40IDUgNiA3Iiwib3V0cHV0IjoiIDMgNCAxIDJcbiA0IDUgMiAzXG4gNSA2IDMgNFxuIDYgNyA0IDVcbiJ9LHsiaW5wdXQiOiI0IDNcbjEgMiAzIDRcbjIgMyA0IDVcbjMgNCA1IDZcbjQgNSA2IDciLCJvdXRwdXQiOiIgNCAxIDIgM1xuIDUgMiAzIDRcbiA2IDMgNCA1XG4gNyA0IDUgNlxuIn0seyJpbnB1dCI6IjUgM1xuMSAyIDMgNCA1XG4yIDMgNCA1IDZcbjMgNCA1IDYgN1xuNCA1IDYgNyA4XG41IDYgNyA4IDkiLCJvdXRwdXQiOiIgNCA1IDEgMiAzXG4gNSA2IDIgMyA0XG4gNiA3IDMgNCA1XG4gNyA4IDQgNSA2XG4gOCA5IDUgNiA3XG4ifSx7ImlucHV0IjoiNiA0XG4xIDIgMyA0IDUgNlxuMiAzIDQgNSA2IDdcbjMgNCA1IDYgNyA4XG40IDUgNiA3IDggOVxuNSA2IDcgOCA5IDEwXG42IDcgOCA5IDEwIDExIiwib3V0cHV0IjoiIDUgNiAxIDIgMyA0XG4gNiA3IDIgMyA0IDVcbiA3IDggMyA0IDUgNlxuIDggOSA0IDUgNiA3XG4gOSAxMCA1IDYgNyA4XG4gMTAgMTEgNiA3IDggOVxuIn1d&tpmScript=ZWNobyAndWxpbWl0IC1mIDEwMDAwMCcgPj4gL3Jvb3QvLmJhc2hyYyAgOyBzb3VyY2UgL3Jvb3QvLmJhc2hyYwojIS9iaW4vYmFzaApjZCBXT1JLU1BBQ0UKCmNoYWxsZW5nZVByb2dyYW1OYW1lcz0oInN0ZXAxL3NhbGVzQ2hhbmdlLmNwcCIgInN0ZXAyL21heEluY3JlYXNlLmNwcCIgInN0ZXAzL21vbmtleUtpbmcuY3BwIiAic3RlcDQvc2lsbHlOdW1iZXIuY3BwIiAic3RlcDUvcm90YXRlTGVmdC5jcHAiICJzdGVwNi91cHZvdGUuY3BwIikKaW5wdXQ9JDI7T0xEX0lGUz0iJElGUyI7IElGUz0sOyBpbnM9KCRpbnB1dCk7SUZTPSIkT0xEX0lGUyIKCmVjaG8gJ3VsaW1pdCAtZiAxMDAwMDAwJyA-Pi9yb290Ly5iYXNocmMgIDsgc291cmNlIC9yb290Ly5iYXNocmMKCmNvbXBpbGUoKXsKICAgICAgICBjb21waWxlQ29tbWFuZD0iZysrICIKICAgICAgICBjaGFsbGVuZ2VQcm9ncmFtTmFtZT0ke2NoYWxsZW5nZVByb2dyYW1OYW1lc1skMSAtIDFdfQoJI3JlbW92ZSB0aGUgZXhlY3V0ZUZpbGUub3V0IGZpbGUgdGhhdCBsYXN0IHRpbWUgcmVtYWlucwogICAgICAgIHJtIC1mIC4vZXhlY3V0ZUZpbGUub3V0ICY-IC9kZXYvbnVsbAoKICAgICNjb21waWxlIGFsbCAuYyBmaWxlIGluIHRoZSBzb3VyY2UgZm9sZGVyOiBhL2IvYy5jcHAgLS0-IGEvYi8qLmNwcAogICAgICAgIGNoYWxsZW5nZVByb2dyYW1OYW1lPSR7Y2hhbGxlbmdlUHJvZ3JhbU5hbWUlLyouY3BwfSIvKi5jcHAiCgogICAgICAgICMg6I635Y-W57yW6K-R57uT5p6c77yI5q2k5aSE57yW6K-R5peg6L6T5Ye65YiZ6K-05piO57yW6K-R6YCa6L-H77yM5ZCm5YiZ6L6T5Ye657yW6K-R6ZSZ6K-v5L-h5oGv77yM6K-35oyJ5a6e6K6t5a6e6ZmF5oOF5Ya16LCD5pW077yJCiAgICAgICAgY29tcGlsZVJlc3VsdD0kKCRjb21waWxlQ29tbWFuZCAkY2hhbGxlbmdlUHJvZ3JhbU5hbWUgLW8gZXhlY3V0ZUZpbGUub3V0IDI-JjEgfCBiYXNlNjQpCiAgICAgICAgaWYgWyAteiAiJGNvbXBpbGVSZXN1bHQiIF07IHRoZW4KICAgICAgICAgICAgICAgIGNvbXBpbGVSZXN1bHQ9JChlY2hvIC1uICJjb21waWxlIHN1Y2Nlc3NmdWxseSIgfCBiYXNlNjQpCiAgICAgICAgZmkKCn0KY29tcGlsZSAkMQoKCmV4ZWN1dGUoKXsKICAgICAgICBleGVjdXRlQ29tbWFuZD0iLi9leGVjdXRlRmlsZS5vdXQiCiAgICAgICAgY2hhbGxlbmdlU3RhZ2U9JDEKCQoJI2dldCB0aGUgbG9vcCB0aW1lcyhsb29wdGltZXMgPSB0aGUgbnVtIG9mIHRlc3RkYXRhc2V0KQogICAgICAgIG91dHB1dD0nJwogICAgICAgIGk9MAogICAgICAgIHdoaWxlIFtbIGkgLWx0ICR7I2luc1sqXX0gXV07IGRvCiAgICAgICAgICAgICPmiafooYzvvIzlubbmi7zmjqXmiafooYznu5PmnpwKICAgICAgICAgICAgcmVzdWx0PSQoZWNobyAiJHtpbnNbJGldfSIgfCBiYXNlNjQgLWQgfCAkZXhlY3V0ZUNvbW1hbmQgfCBiYXNlNjQpCiAgICAgICAgICAgICPmi7zmjqXovpPlh7rnu5PmnpwKICAgICAgICAgICAgb3V0cHV0PSRvdXRwdXRcIiRyZXN1bHRcIiwKICAgICAgICAgICAgbGV0IGkrKwogICAgICAgIGRvbmUKICAgICAgICBvdXRwdXQ9Ilske291dHB1dCU_fV0iCn0KCmV4ZWN1dGUgJDEKCiNyZXR1cm4gcmVzdWx0IGluIGpzb24gZm9ybWF0CnJldHVyblJlc3VsdCgpewogICAgICAgIHJlc3VsdD0ie1wiY29tcGlsZVJlc3VsdFwiOlwiJGNvbXBpbGVSZXN1bHRcIixcIm91dFwiOiRvdXRwdXR9IgogICAgICAgIGVjaG8gJHJlc3VsdAp9CiPmi7zoo4XmiJDmnIDnu4jnmoRqc29u5qC85byP77yMZWNob-i-k-WHuuW-l-WIsOacgOWQjue7k-aenApyZXR1cm5SZXN1bHQKCg==&timeLimit=10&resubmit=1564539997&times=1&podType=0&containers=W3siaW1hZ2UiOiJnY2Mtc3NoOnYxLjAiLCJjcHVMaW1pdCI6MSwiY3B1UmVxdWVzdCI6MC4xLCJtZW1vcnlMaW1pdCI6IjEwMjRNIiwibWVtb3J5UmVxdWVzdCI6IjEwMDAwTSIsInJlc291cmNlTGltaXQiOiIxMDAwMEsiLCJ0eXBlIjoibWFpbiJ9XQ==&content_modified=1&sec_key=p9uba6wci37k";
		Map<String, Object> params = new HashMap<>();
		params.put("a", "aa");

		AtomicInteger num = new AtomicInteger(1);
		
		CloseableHttpAsyncClient client = NioHttpClientUtils2.getClient();
		for (int i = 0; i < 500; i++) {
			new Thread(new Runnable() {

				@Override
				public void run() {
					String url2 = url + String.format(p, num.getAndIncrement());
					String result = NioHttpClientUtils2.sendPost(client, url2, params);
					System.out.println("result:" + result);
				}
			}).start();

		}

		Thread.currentThread().sleep(5 * 1000);


		NioHttpClientUtils2.close(client);
	}

}
